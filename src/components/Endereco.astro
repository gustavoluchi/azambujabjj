<section class="mb-8 flex w-full max-w-6xl justify-center xl:w-4/6">
  <div class="bg-base-100 border-base-300 collapse-arrow collapse border">
    <input
      id="map-toggle"
      type="checkbox"
      name="colapsavel-mapa"
      aria-label="Checkbox para abrir colapsável do mapa do endereço"
      aria-controls="map-placeholder"
    />
    <div class="collapse-title font-semibold">
      Endereço: Av. Osvaldo Aranha, 794 - Bom Fim, Porto Alegre/RS. Clique para
      abrir o mapa
    </div>
    <div class="collapse-content text-sm">
      <!-- Placeholder where iframe will be inserted when the collapse is opened -->
      <div
        id="map-placeholder"
        class="relative h-96 w-full overflow-hidden sm:rounded-xl sm:py-2 md:rounded-2xl"
        data-src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3454.1069427636658!2d-51.21689218712032!3d-30.033789630681063!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95197972651a453b%3A0x1195870ed3ae9c84!2sEscola%20de%20Jiu-Jitsu%20Azambuja-Behring!5e0!3m2!1spt-BR!2sbr!4v1736881101041!5m2!1spt-BR!2sbr"
        aria-live="polite"
      >
        <!-- Loading state shown while iframe is loading -->
        <div
          id="map-loading"
          class="absolute inset-0 flex items-center justify-center bg-gray-100"
          aria-hidden={false}
        >
          <svg
            class="h-10 w-10 animate-spin text-gray-400"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            aria-hidden={true}
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span class="sr-only">Carregando mapa</span>
        </div>
      </div>

      <!-- Fallback for users without JS: render the iframe statically -->
      <noscript>
        <iframe
          src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3454.1069427636658!2d-51.21689218712032!3d-30.033789630681063!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95197972651a453b%3A0x1195870ed3ae9c84!2sEscola%20de%20Jiu-Jitsu%20Azambuja-Behring!5e0!3m2!1spt-BR!2sbr!4v1736881101041!5m2!1spt-BR!2sbr"
          class="h-96 w-full sm:rounded-xl sm:py-2 md:rounded-2xl"
          allowfullscreen
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          title="Google maps mostrando o endereço Av. Osvaldo Aranha, 794 - Bom Fim, Porto Alegre - RS, 90035-191."
        ></iframe>
      </noscript>

      <script type="module">
        // Lazy-insert or remove iframe when the collapse checkbox is toggled
        const toggle = document.getElementById("map-toggle");
        const placeholder = document.getElementById("map-placeholder");

        function createIframe() {
          if (!placeholder || placeholder.querySelector("iframe")) return;
          const src = placeholder.getAttribute("data-src");
          if (!src) return;

          const loadingEl = document.getElementById("map-loading");
          if (loadingEl) {
            loadingEl.style.display = "flex";
            loadingEl.setAttribute("aria-hidden", false);
          }

          const iframe = document.createElement("iframe");
          iframe.src = src;
          iframe.className = "h-full w-full"; // fill the placeholder
          iframe.style.opacity = "0";
          iframe.style.transition = "opacity 300ms ease-in-out";
          iframe.loading = "lazy";
          iframe.title =
            "Google maps mostrando o endereço Av. Osvaldo Aranha, 794 - Bom Fim, Porto Alegre - RS, 90035-191.";
          iframe.referrerPolicy = "no-referrer-when-downgrade";
          iframe.allowFullscreen = true;

          // When iframe finishes loading, hide the loader and fade in the map
          iframe.addEventListener(
            "load",
            () => {
              if (loadingEl) {
                loadingEl.style.display = "none";
                loadingEl.setAttribute("aria-hidden", true);
              }
              iframe.style.opacity = "1";
            },
            { once: true },
          );

          placeholder.appendChild(iframe);
        }

        function removeIframe() {
          if (!placeholder) return;
          const iframe = placeholder.querySelector("iframe");
          const loadingEl = document.getElementById("map-loading");
          if (iframe) placeholder.removeChild(iframe);
          if (loadingEl) {
            loadingEl.style.display = "flex";
            loadingEl.setAttribute("aria-hidden", false);
          }
        }

        // Insert iframe when opened; remove when closed to free resources
        if (toggle && placeholder) {
          // If page loads with checkbox already checked, ensure iframe is present
          if (toggle.checked) createIframe();
          toggle.addEventListener("change", (e) => {
            if (e.target.checked) createIframe();
            else removeIframe();
          });
        }
      </script>
    </div>
  </div>
</section>
